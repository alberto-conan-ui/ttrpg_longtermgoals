# Domain Model

This document describes the entity-relationship model for TTRPG Long-Term Goals. Updated each stage as new entities are added.

---

## Stage 1 — Users & Sessions

```
┌──────────────────────────┐
│         users            │
├──────────────────────────┤
│ id          UUID PK      │
│ email       TEXT UNIQUE   │
│ google_id   TEXT UNIQUE?  │
│ discord_id  TEXT UNIQUE?  │
│ username    TEXT UNIQUE?  │
│ hashed_password TEXT?     │
│ display_name TEXT         │
│ avatar_url   TEXT?        │
│ created_at  TIMESTAMPTZ   │
│ updated_at  TIMESTAMPTZ   │
└──────────┬───────────────┘
           │ 1
           │
           │ *
┌──────────┴───────────────┐
│        sessions          │
├──────────────────────────┤
│ id          TEXT PK      │
│ user_id     UUID FK      │
│ expires_at  TIMESTAMPTZ   │
└──────────────────────────┘
```

### Relationships

- **users → sessions**: One user has many sessions (1:N)

### Notes

- `google_id`, `discord_id`, `username`, `hashed_password` are nullable — a user may authenticate via any combination of providers
- `username` + `hashed_password` are only used when local auth is enabled (non-production)
- Session IDs are opaque strings generated by Lucia, not UUIDs

---

## Stage 3 — Campaigns & Members

```
┌──────────────────────────┐
│       campaigns          │
├──────────────────────────┤
│ id          UUID PK      │
│ name        TEXT          │
│ description TEXT?         │
│ dm_id       UUID FK→users │
│ invite_code TEXT UNIQUE?  │
│ created_at  TIMESTAMPTZ   │
│ updated_at  TIMESTAMPTZ   │
└──────────────────────────┘

┌──────────────────────────┐
│    campaign_members      │
├──────────────────────────┤
│ campaign_id UUID FK      │
│ user_id     UUID FK      │
│ role        ENUM(dm,player) │
│ joined_at   TIMESTAMPTZ   │
│ PK(campaign_id, user_id) │
└──────────────────────────┘
```

### Relationships

- **campaigns → users (dm)**: Each campaign has one DM (N:1 via `dm_id`)
- **campaign_members**: Join table linking users to campaigns with a role (M:N)
- **campaigns → campaign_members**: One campaign has many members (1:N)
- **users → campaign_members**: One user can be in many campaigns (1:N)

---

## Stage 5a — Campaign Tree (Parts, Sessions, Lore Fragments)

### Modified: campaigns (new columns)

```
┌──────────────────────────────────────┐
│       campaigns (new columns)        │
├──────────────────────────────────────┤
│ + marker_session_id  UUID? FK→       │
│     campaign_sessions (SET NULL)     │
│ + marker_between     BOOL DEFAULT F  │
│ + showcase_json      JSONB?          │
│ + allow_contributions BOOL DEFAULT F │
└──────────────────────────────────────┘
```

### New tables

```
┌──────────────────────────────┐
│      campaign_parts          │
├──────────────────────────────┤
│ id               UUID PK     │
│ campaign_id      UUID FK     │
│ name             TEXT         │
│ sort_order       INT          │
│ showcase_json    JSONB?       │
│ showcase_owner_id UUID FK?   │
│ allow_contributions BOOL     │
│ created_at       TIMESTAMPTZ  │
└──────────────────────────────┘

┌──────────────────────────────┐
│     campaign_sessions        │
├──────────────────────────────┤
│ id               UUID PK     │
│ part_id          UUID FK     │
│ name             TEXT         │
│ status     ENUM(planned,played) │
│ sort_order       INT          │
│ showcase_json    JSONB?       │
│ showcase_owner_id UUID FK?   │
│ allow_contributions BOOL     │
│ created_at       TIMESTAMPTZ  │
└──────────────────────────────┘

┌──────────────────────────────┐
│      lore_fragments          │
├──────────────────────────────┤
│ id            UUID PK        │
│ campaign_id   UUID FK        │
│ owner_id      UUID FK        │
│ title         TEXT            │
│ content_json  JSONB           │
│ scope    ENUM(story,private)  │
│ visibility ENUM(private,     │
│            shared,public)     │
│ part_id       UUID? FK       │
│ session_id    UUID? FK       │
│ player_id     UUID? FK       │
│ created_at    TIMESTAMPTZ     │
│ updated_at    TIMESTAMPTZ     │
└──────────────────────────────┘

┌──────────────────────────────┐
│   lore_fragment_shares       │
├──────────────────────────────┤
│ fragment_id   UUID FK        │
│ user_id       UUID FK        │
│ PK(fragment_id, user_id)    │
└──────────────────────────────┘
```

### Relationships

- **campaign_parts → campaigns**: Each part belongs to one campaign (N:1, CASCADE)
- **campaign_sessions → campaign_parts**: Each session belongs to one part (N:1, CASCADE)
- **campaigns.marker_session_id → campaign_sessions**: Marker points to a session (SET NULL)
- **lore_fragments → campaigns**: Each fragment belongs to one campaign (N:1, CASCADE)
- **lore_fragments.owner_id → users**: Fragment owner (N:1, CASCADE)
- **lore_fragments**: Polymorphic attachment via nullable `part_id`, `session_id`, `player_id`
- **lore_fragment_shares**: Join table for shared visibility (M:N between fragments and users)

### Campaign status (derived)

- **Preparation**: `marker_session_id` is NULL
- **Playing**: `marker_session_id` is set

### Marker position

- **On a session**: `marker_between = false` — "just played this session"
- **Between sessions**: `marker_between = true` — downtime/idle phase active

---

## Future Stages (planned, not yet implemented)

### Stage 6 — Idle Tracks

Idle tracks (investigation tracks reborn) will be available during the "between sessions" downtime phase. Depends on the marker and lifecycle from Stage 5b. **Not yet designed.**
