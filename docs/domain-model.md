# Domain Model

This document describes the entity-relationship model for TTRPG Long-Term Goals. Updated each stage as new entities are added.

---

## Stage 1 — Users & Sessions

```
┌──────────────────────────┐
│         users            │
├──────────────────────────┤
│ id          UUID PK      │
│ email       TEXT UNIQUE   │
│ google_id   TEXT UNIQUE?  │
│ discord_id  TEXT UNIQUE?  │
│ username    TEXT UNIQUE?  │
│ hashed_password TEXT?     │
│ display_name TEXT         │
│ avatar_url   TEXT?        │
│ created_at  TIMESTAMPTZ   │
│ updated_at  TIMESTAMPTZ   │
└──────────┬───────────────┘
           │ 1
           │
           │ *
┌──────────┴───────────────┐
│        sessions          │
├──────────────────────────┤
│ id          TEXT PK      │
│ user_id     UUID FK      │
│ expires_at  TIMESTAMPTZ   │
└──────────────────────────┘
```

### Relationships

- **users → sessions**: One user has many sessions (1:N)

### Notes

- `google_id`, `discord_id`, `username`, `hashed_password` are nullable — a user may authenticate via any combination of providers
- `username` + `hashed_password` are only used when local auth is enabled (non-production)
- Session IDs are opaque strings generated by Lucia, not UUIDs

---

## Stage 3 — Campaigns & Members

```
┌──────────────────────────┐
│       campaigns          │
├──────────────────────────┤
│ id          UUID PK      │
│ name        TEXT          │
│ description TEXT?         │
│ dm_id       UUID FK→users │
│ invite_code TEXT UNIQUE?  │
│ created_at  TIMESTAMPTZ   │
│ updated_at  TIMESTAMPTZ   │
└──────────────────────────┘

┌──────────────────────────┐
│    campaign_members      │
├──────────────────────────┤
│ campaign_id UUID FK      │
│ user_id     UUID FK      │
│ role        ENUM(dm,player) │
│ joined_at   TIMESTAMPTZ   │
│ PK(campaign_id, user_id) │
└──────────────────────────┘
```

### Relationships

- **campaigns → users (dm)**: Each campaign has one DM (N:1 via `dm_id`)
- **campaign_members**: Join table linking users to campaigns with a role (M:N)
- **campaigns → campaign_members**: One campaign has many members (1:N)
- **users → campaign_members**: One user can be in many campaigns (1:N)

---

## Future Stages (planned, not yet implemented)

### Stage 5 — Investigation Tracks

```
┌──────────────────────────────┐
│    investigation_tracks      │
├──────────────────────────────┤
│ id            UUID PK        │
│ campaign_id   UUID FK        │
│ name          TEXT            │
│ description   TEXT?           │
│ created_at    TIMESTAMPTZ     │
└──────────────────────────────┘

┌──────────────────────────────┐
│    track_milestones          │
├──────────────────────────────┤
│ id            UUID PK        │
│ track_id      UUID FK        │
│ title         TEXT            │
│ threshold     INT             │
│ description   TEXT?           │
└──────────────────────────────┘

┌──────────────────────────────┐
│    player_track_progress     │
├──────────────────────────────┤
│ player_id     UUID FK→users  │
│ track_id      UUID FK        │
│ progress      INT             │
│ updated_at    TIMESTAMPTZ     │
│ PK(player_id, track_id)     │
└──────────────────────────────┘
```

### Stage 6 — Downtime Phases

```
┌──────────────────────────────┐
│      downtime_phases         │
├──────────────────────────────┤
│ id            UUID PK        │
│ campaign_id   UUID FK        │
│ status        ENUM(open,     │
│               allocating,    │
│               resolving,     │
│               closed)        │
│ opened_at     TIMESTAMPTZ     │
│ closed_at     TIMESTAMPTZ?    │
└──────────────────────────────┘

┌──────────────────────────────┐
│     time_allocations         │
├──────────────────────────────┤
│ id            UUID PK        │
│ phase_id      UUID FK        │
│ player_id     UUID FK→users  │
│ track_id      UUID FK        │
│ hours         INT             │
└──────────────────────────────┘
```
